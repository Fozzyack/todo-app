# ToDoList Backend

ASP.NET Core 9.0 REST API providing authentication and todo management with PostgreSQL persistence and ASP.NET Core Identity.

## Tech Stack

- **Framework**: ASP.NET Core 9.0 (Web API)
- **Database**: PostgreSQL with Entity Framework Core 9.0.9
- **Authentication**: ASP.NET Core Identity with cookie-based authentication
- **API Documentation**: Scalar API Reference 2.8.8 (development mode)
- **ORM**: Entity Framework Core with Npgsql 9.0.4 provider

## Project Structure

```
backend/Backend/
├── Controllers/           # API controllers
│   └── TodosController.cs # Todo CRUD operations
├── Models/               # Entity models
│   ├── Todo.cs           # Todo entity with due date
│   └── User.cs           # IdentityUser extension
├── Requests/             # Request DTOs
│   └── CreateTodoRequest.cs
├── Migrations/           # EF Core database migrations
│   ├── 20251004071322_init.cs
│   ├── 20251006160755_AddTodo.cs
│   ├── 20251006162227_AddTodos.cs
│   ├── 20251011143711_TodoUpdate.cs
│   └── AppDbContextModelSnapshot.cs
├── Properties/
│   └── launchSettings.json
├── AppDbContext.cs       # Database context (IdentityDbContext)
├── BaseController.cs     # Base controller with routing
├── Program.cs            # Application entry point and service config
├── appsettings.json      # Base configuration
├── appsettings.Development.json  # Development configuration
├── Backend.csproj        # Project file
└── Backend.http          # HTTP request examples

```

## Getting Started

### Prerequisites

- **.NET 9.0 SDK** ([dotnet.microsoft.com](https://dotnet.microsoft.com/download))
- **PostgreSQL database** (via Docker Compose recommended)

### Installation

```bash
cd backend/Backend
dotnet restore
dotnet build
```

### Database Setup

#### 1. Start PostgreSQL (Docker Compose)

From the project root:

```bash
docker compose up -d
```

This starts PostgreSQL on `localhost:5000` (mapped from container port 5432).

#### 2. Configure Connection String

Connection string is already configured in `appsettings.Development.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=todo;Username=postgres;Password=postgres;Port=5000"
  }
}
```

**Note**: Port `5000` matches the Docker Compose port mapping.

#### 3. Apply Migrations

```bash
dotnet ef database update
```

This creates the database schema with Identity tables and the `Todos` table.

### Development

```bash
dotnet run
```

API runs at **`https://localhost:5141`** with HTTPS redirection enabled.

#### Available Endpoints:
- **Scalar API documentation**: `/scalar/v1` (development mode only)
- **Identity endpoints**: `/register`, `/login`, `/logout`
- **Todo endpoints**: `/Todos`

## API Endpoints

### Authentication (ASP.NET Core Identity)

Endpoints are automatically generated by `MapIdentityApi<User>()`.

- **`POST /register`**
  - Register new user account
  - Body: `{ "email": "user@example.com", "password": "Password123!" }`
  - Returns: `200 OK` on success

- **`POST /login?useCookies=true&useSessionCookies=true`**
  - Authenticate user and set session cookie
  - Body: `{ "email": "user@example.com", "password": "Password123!" }`
  - Returns: `200 OK` with `Set-Cookie` header
  - Cookie name: `.AspNetCore.Identity.Application`

- **`POST /logout?useCookies=true&useSessionCookies=true`**
  - Sign out user and clear authentication cookie
  - Requires: Authentication cookie in request
  - Returns: `200 OK`

### Todos

All todo endpoints require authentication (cookie must be present).

- **`GET /Todos`**
  - Get all todos for authenticated user
  - Returns: `200 OK` with array of todo objects

- **`POST /Todos`**
  - Create new todo
  - Body: `{ "name": "Task name", "description": "Details", "date": "2025-12-31" }`
  - Returns: `201 Created` with created todo object and `Location` header

- **`DELETE /Todos/{id}`**
  - Delete specific todo (must be owned by authenticated user)
  - Returns: `200 OK` on success, `404 Not Found` if not found, `401 Unauthorized` if not authenticated

## Models

### Todo Entity

```csharp
public class Todo
{
    public Guid Id { get; set; }
    public string? Name { get; set; }                    // Required
    public string? Description { get; set; }             // Optional
    public bool Completed { get; set; } = false;
    public string? UserId { get; set; }                  // Required, FK to User
    public User User { get; set; } = null!;
    public DateTime DueDate { get; set; }                // Required
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}
```

### User Entity

```csharp
public class User : IdentityUser { }
```

Extends `IdentityUser` from ASP.NET Core Identity with standard properties:
- `Id` (string)
- `UserName` (string)
- `Email` (string)
- `PasswordHash` (string)
- And other Identity properties

## Configuration

### appsettings.json

Base configuration (production-safe, no secrets):

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

### appsettings.Development.json

Development-specific configuration:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=todo;Username=postgres;Password=postgres;Port=5000"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

**Security Note**: Never commit production credentials. Use environment variables or secret managers for production deployments.

## Database Migrations

### Migration History

1. `20251004071322_init` - Initial Identity schema
2. `20251006160755_AddTodo` - Add Todo entity (initial)
3. `20251006162227_AddTodos` - Update Todos schema
4. `20251011143711_TodoUpdate` - Add DueDate and other fields

### Creating New Migrations

When modifying models:

```bash
cd backend/Backend
dotnet ef migrations add <DescriptiveName>
```

This generates a new migration file in `Migrations/`.

### Applying Migrations

```bash
dotnet ef database update
```

Applies all pending migrations to the database.

### Rollback Migrations

```bash
dotnet ef database update <PreviousMigrationName>
```

## Architecture

### Service Configuration (Program.cs)

Key services registered:
- **Controllers**: `AddControllers()`
- **OpenAPI**: `AddOpenApi()` for Scalar documentation
- **DbContext**: `AddDbContext<AppDbContext>()` with Npgsql
- **CORS**: Configured for `http://localhost:3000` (frontend) with credentials
- **Authentication**: Cookie-based with `AddCookie(IdentityConstants.ApplicationScheme)`
- **Identity**: `AddIdentityCore<User>()` with EF stores and API endpoints

### Middleware Pipeline (Program.cs)

1. OpenAPI/Scalar (development only)
2. HTTPS redirection
3. CORS
4. Authentication/Authorization (implicit via Identity)
5. Identity API endpoints (`MapIdentityApi<User>()`)
6. Controllers

### Database Context (AppDbContext.cs)

Extends `IdentityDbContext<User>`:
- Inherits all Identity tables (Users, Roles, Claims, etc.)
- Adds `Todos` DbSet
- Configures `CreatedAt` default value with `HasDefaultValueSql("NOW()")`

### Base Controller (BaseController.cs)

```csharp
[ApiController]
[Route("[controller]")]
public class BaseController : ControllerBase { }
```

All controllers inherit from `BaseController` for consistent routing.

### TodosController

Handles CRUD operations for todos:
- Uses `ClaimTypes.NameIdentifier` to get authenticated user ID
- Filters todos by `UserId` to ensure users only see their own data
- Returns `401 Unauthorized` if user is not authenticated

## CORS Configuration

CORS is configured to allow frontend (`http://localhost:3000`) to make authenticated requests:

```csharp
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.WithOrigins("http://localhost:3000")
              .WithHeaders("Content-Type")
              .AllowCredentials();
    });
});
```

**Important**: `AllowCredentials()` enables cookie-based authentication across origins.

## Development Tips

### View API Documentation

In development mode, navigate to:
- `https://localhost:5141/scalar/v1`

This provides an interactive API reference powered by Scalar.

### Test Endpoints

Use the included `Backend.http` file with VS Code REST Client extension or similar tools.

### Enable Detailed Logging

In `appsettings.Development.json`, adjust log levels:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  }
}
```

### Troubleshooting

**Connection Errors**:
- Verify PostgreSQL is running: `docker ps`
- Check port 5000 is not in use: `lsof -i :5000` (Linux/Mac)
- Verify connection string matches Docker Compose configuration

**Migration Errors**:
- Ensure database is accessible
- Check `dotnet ef` tools are installed: `dotnet tool install --global dotnet-ef`

**Authentication Errors**:
- Verify cookies are included in requests (`credentials: "include"`)
- Check CORS configuration allows credentials from frontend origin

## Related Documentation

- See [CLAUDE.md](../../CLAUDE.md) for detailed architecture patterns
- See [AGENTS.md](../../AGENTS.md) for contribution guidelines
- See root [README.md](../../README.md) for full-stack setup
